---
const base = import.meta.env.BASE_URL;

const activitySections = [
  {
    title: 'Interactive Tools',
    icon: 'üéÆ',
    activities: [
      { title: 'Piano', href: `${base}learn/interactive-tools/piano/`, icon: 'üéπ' },
      { title: 'Guitar', href: `${base}learn/interactive-tools/guitar/`, icon: 'üé∏' },
      { title: 'Sample Explorer', href: `${base}learn/interactive-tools/sample-explorer/`, icon: 'üîä' },
    ]
  },
  {
    title: 'Quizzes',
    icon: 'üéØ',
    activities: [
      { title: 'Sample Quiz', href: `${base}learn/quizzes/sample-guessing/`, icon: 'üéØ' },
      { title: 'Waveform Quiz', href: `${base}learn/quizzes/waveform-guessing/`, icon: '„Ä∞' },
      { title: 'Effect Quiz', href: `${base}learn/quizzes/effect-guessing/`, icon: 'üéõ' },
      { title: 'Ear Training', href: `${base}learn/quizzes/ear-training/`, icon: 'üëÇ' },
    ]
  },
  {
    title: 'Music Theory',
    icon: 'üéµ',
    activities: [
      { title: 'Harmony', href: `${base}learn/theory/harmony/`, icon: 'üé∂' },
      { title: 'Chord Composition', href: `${base}learn/theory/chord-composition/`, icon: 'üéº' },
      { title: 'Rhythms', href: `${base}learn/theory/euclidean-101/`, icon: 'ü•Å' },
      { title: 'Auditory Space', href: `${base}learn/theory/auditory-space/`, icon: 'üéõÔ∏è' },
    ]
  },
  {
    title: 'Genre Studies',
    icon: 'üé∏',
    activities: [
      { title: 'Rock & Pop', href: `${base}learn/genre/rock-pop/`, icon: 'üé§' },
      { title: 'EDM', href: `${base}learn/genre/edm/`, icon: 'üéß' },
      { title: 'Metal', href: `${base}learn/genre/metal/`, icon: 'ü§ò' },
      { title: 'Demoscene', href: `${base}learn/genre/demoscene/`, icon: 'üñ•Ô∏è' },
    ]
  },
];

const currentPath = Astro.url.pathname;

// Check if any activity in section is active
const isSectionActive = (activities: any[]) => {
  return activities.some(activity => currentPath.includes(activity.href.replace(base, '/')));
};
---

<nav class="flex flex-col gap-1 h-full overflow-y-auto">
  <a
    href={base}
    class="flex items-center gap-2 px-3 py-2 text-sm text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg transition-colors mb-2"
  >
    <span>‚Üê</span>
    <span>JamDojo</span>
  </a>

  {activitySections.map((section, sectionIndex) => {
    const sectionId = `activity-section-${sectionIndex}`;
    const isActive = isSectionActive(section.activities);
    return (
      <div class="mb-1">
        <button
          class="activity-accordion-header w-full text-left px-3 py-2 hover:bg-gray-800 rounded-lg transition-colors flex items-center justify-between text-sm text-gray-400"
          aria-expanded={isActive ? "true" : "false"}
          aria-controls={sectionId}
        >
          <div class="flex items-center gap-2">
            <span>{section.icon}</span>
            <span class="font-medium">{section.title}</span>
          </div>
          <svg
            class="activity-accordion-icon w-4 h-4 transition-transform"
            style={isActive ? "transform: rotate(90deg)" : ""}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
        <div id={sectionId} class="activity-accordion-content pl-4" style={isActive ? "" : "display: none;"}>
          {section.activities.map((activity) => {
            const isActivityActive = currentPath.includes(activity.href.replace(base, '/'));
            return (
              <a
                href={activity.href}
                class:list={[
                  'flex items-center gap-3 px-3 py-2 rounded-lg transition-colors text-sm',
                  isActivityActive
                    ? 'bg-cyan-600 text-white'
                    : 'text-gray-300 hover:bg-gray-800 hover:text-white'
                ]}
              >
                <span class="text-lg">{activity.icon}</span>
                <span>{activity.title}</span>
              </a>
            );
          })}
        </div>
      </div>
    );
  })}

  <div class="mt-auto pt-4 border-t border-gray-800 text-xs text-gray-500 space-y-1">
    <a href="https://github.com/kimjune01/jamdojo" target="_blank" rel="noopener" class="block hover:text-cyan-400">JamDojo Source</a>
    <a href="https://github.com/tidalcycles/strudel" target="_blank" rel="noopener" class="block hover:text-cyan-400">Strudel (AGPL-3.0)</a>
  </div>
</nav>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const accordionHeaders = document.querySelectorAll('.activity-accordion-header');
    accordionHeaders.forEach((header) => {
      header.addEventListener('click', () => {
        const content = header.nextElementSibling;
        const icon = header.querySelector('.activity-accordion-icon');
        const isExpanded = header.getAttribute('aria-expanded') === 'true';

        if (isExpanded) {
          content.style.display = 'none';
          header.setAttribute('aria-expanded', 'false');
          icon.style.transform = 'rotate(0deg)';
        } else {
          content.style.display = 'block';
          header.setAttribute('aria-expanded', 'true');
          icon.style.transform = 'rotate(90deg)';
        }
      });
    });
  });
</script>
